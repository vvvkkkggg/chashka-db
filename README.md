# БД Чашка

- [Task 1: Предметная область](#предметная-область)
- [Task 2a: Концептуальная модель](#концептуальная-модель)
- [Task 2b: Логическая модель](#логическая-модель)
    - [3НФ](#3нф)
    - [SCD4](#scd4)
- [Task 2c: Физическая модель](#физическая-модель)
    - [Coffee shop](#coffee-shop)
    - [Barista](#barista)
    - [Item](#item)
    - [Receipt](#receipt)
    - [Customer](#customer)
    - [Reward](#reward)
    - [Customer reward](#customer-reward)
    - [Coffee shop customer](#coffee-shop-customer)
    - [Receipt item](#receipt-item)
- [Task 3: DDL скрипт для создания БД](#ddl-скрипт-для-создания-бд)
- [Task 4: Наполнение БД](#наполнение-бд)
- [Task 5: CRUD-запросы](#crud-запросы)
- [Task 6: Смысловые запросы](#смысловые-запросы)
- [Task 7: Простые представления](#простые-представления)
- [Task 8: Сложные представления](#сложные-представления)
---

### Предметная область

Программа лояльности для маленьких несетевых кофеен. Пользователи сканируют чеки, накапливают и обменивают бонусы на награды на усмотрение кофейни.

### Концептуальная модель

![concept](/draw.io/concept.png)

### Логическая модель

![logic](/draw.io/logic.png)

#### 3НФ

Почему 3НФ?

- Минимизация избыточности данных: уменьшает повторение информации.
- Адаптация к изменениям: обеспечивает легкость адаптации к изменениям без влияния на другие части БД.
- Снижение аномалий данных: уменьшает возможность появления аномалий при вставке, обновлении или удалении данных.
- Ясная структура данных: создает более ясную и понятную структуру данных, облегчая проектирование и понимание.

#### SCD4

Со временем владелец можем менять данные о продуктах, например, стоимость, фотографию, название или статус продажи.
Добавим возможность сохранять тенденцию, что можем помочь при дальнейшем анализе. Будем использовать подход SCD4. 

![scd](/draw.io/scd.png)

### Физическая модель 

#### Coffee shop

| PK/FK |   Название   |           Описание            | Тип данных   |    Ограничения    |
|-------|---------------|------------------------------|--------------|-------------------|
| PK    | coffee_shop_id| Идентификатор кофейни        | SERIAL       | PRIMARY KEY       |
|       |     name      | Название кофейни             | VARCHAR(255) | NOT NULL          |
|       |     inn       | ИНН (Идентификационный номер налогоплательщика) | VARCHAR(10)  | NOT NULL |
|       |     kkt       | Регистрационный номер кассы   | VARCHAR(16)  | UNIQUE, NOT NULL  |
|       | image_url     | URL изображения кофейни      | VARCHAR(255) |                   |
|       |   address     | Адрес кофейни                | TEXT         | NOT NULL          |
|       |   cashback_rate     | Доля (процент) возврата потраченных денег в качестве бонусов                  | INTEGER         | NOT NULL, CHECK(cashback_rate <= 100)          |


#### Barista

| PK/FK |   Название   |           Описание            | Тип данных | Ограничения                    |
|-------|---------------|------------------------------|------------|--------------------------------|
| PK    | barista_id    | Идентификатор баристы        | SERIAL     | PRIMARY KEY                    |
| FK    | coffee_shop_id| Идентификатор кофейни (внешний ключ) | INTEGER | REFERENCES coffee_shop(coffee_shop_id) |
|       |     name      | Имя баристы                  | VARCHAR(255)| NOT NULL                       |


#### Item

| PK/FK |   Название   | Описание                           | Тип данных   | Ограничения                            |
|-------|---------------|------------------------------------|--------------|----------------------------------------|
| PK    |  item_id      | Идентификатор товара               | SERIAL       | PRIMARY KEY                            |
| FK    | coffee_shop_id| Идентификатор кофейни (внешний ключ) | INTEGER      | REFERENCES coffee_shop(coffee_shop_id) |
|       |     name      | Название товара                    | VARCHAR(255) | NOT NULL                               |
|       |    price      | Цена товара в копейках             | INTEGER      | NOT NULL, CHECK (price >= 0)   
|       |    saleable      | Индикатор пригодности товара для продажи              | boolean      | DEFAULT FALSE      |
|       |    is_reward      | Индикатор награды              | boolean      | DEFAULT FALSE|
|       | image_url     | URL изображения награды       | VARCHAR(255) |                                       |


#### Receipt

| PK/FK |   Название   | Описание                                  | Тип данных | Ограничения                            |
|-------|---------------|-------------------------------------------|------------|----------------------------------------|
| PK    | receipt_id    | Идентификатор чека                        | SERIAL     | PRIMARY KEY                            |
| FK    | customer_id   | Идентификатор пользователя (внешний ключ) | INTEGER    | REFERENCES customer(customer_id)       |
| FK    | coffee_shop_id| Идентификатор кофейни (внешний ключ)      | INTEGER    | REFERENCES coffee_shop(coffee_shop_id) |
| FK    | barista_id| Идентификатор баристы (внешний ключ)      | INTEGER    | REFERENCES barista(barista_id) |
|       |    total      | Общая сумма чека в копейках                  | INTEGER    | NOT NULL, CHECK (total >= 0)                             |
|       |  qr_data      | Содержимое QR-кода                        | TEXT       | NOT NULL                               |
|       |  receipt_date      | Дата покупки                              | TIMESTAMP  | NOT NULL                               |
|       | bonuses     | Количество бонусов от чека             | INTEGER  | DEFAULT 0              |
|       | timestamp     | Временная метка создания чека             | TIMESTAMP  | DEFAULT CURRENT_TIMESTAMP              |


#### Customer

| PK/FK |   Название   |           Описание            | Тип данных |    Ограничения    |
|-------|---------------|------------------------------|------------|-------------------|
| PK    |  customer_id  | Идентификатор пользователя    | SERIAL     | PRIMARY KEY       |
|       |     name      | Имя пользователя              | VARCHAR(255)| NOT NULL          |
|       |    phone      | Номер телефона пользователя   | VARCHAR(20) | NOT NULL          |


#### Customer reward

| PK/FK |   Название   |           Описание            | Тип данных | Ограничения                      |
|-------|---------------|------------------------------|------------|----------------------------------|
| FK    |  customer_id  | Идентификатор пользователя (внешний ключ) | INTEGER | REFERENCES customer(customer_id) |
| FK    |  item_id    | Идентификатор продукта (внешний ключ) | INTEGER | REFERENCES item(item_id)     |
| PK      |  timestamp     | Временная метка получения награды | TIMESTAMP  | DEFAULT CURRENT_TIMESTAMP        |


#### Coffee shop customer

| PK/FK |   Название   | Описание                                          | Тип данных | Ограничения                            |
|-------|---------------|---------------------------------------------------|------------|----------------------------------------|
| FK    |  customer_id  | Идентификатор пользователя (внешний ключ)         | INTEGER | REFERENCES customer(customer_id)       |
| FK    | coffee_shop_id| Идентификатор кофейни (внешний ключ)              | INTEGER | REFERENCES coffee_shop(coffee_shop_id) |
|       |   bonuses     | Накопленные бонусы пользователя в данной кофейне  | INTEGER    | DEFAULT 0, CHECK (bonuses >= 0)        |


#### Receipt item

| PK/FK |   Название   |           Описание            | Тип данных | Ограничения                    |
|-------|---------------|------------------------------|------------|--------------------------------|
| FK    |  item_id      | Идентификатор товара (внешний ключ) | INTEGER | REFERENCES item(item_id)       |
| FK    |  receipt_id   | Идентификатор чека (внешний ключ) | INTEGER | REFERENCES receipt(receipt_id) |
|       |  quantity       | Количество товара в чеке      | INTEGER    | NOT NULL, CHECK (quantity > 0)   |

### DDL скрипт для создания БД

[DDL скрипт](task3-ddl-scripts.sql), который создает схему, а также все требуемые таблицы.

### Наполнение БД

[Скрипт](task4-inserts.sql), который наполняет БД тестовыми данными.

### CRUD-запросы

[CRUD-запросы](task5-crud.sql), рандомные и бессмысленные, но полностью соответствующие спецификации, описанной в требованиях.

### Смысловые запросы

[Смысловые запросы](task6-queries.sql), перед каждым запросом есть описание, что ожидается получить.

### Простые представления

Простые представления, [тык](task7-view-scripts.sql).

### Сложные представления

Сложные представления, [тык](task8-complex-view-scripts.sql)

### ТРИГГЕРЫ

Кстати, у нас есть триггеры, [вот же они](task9-triggers.sql).
